<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>vSAN磁盘offline场景操作建议指导 | HILL</title><meta name="keywords" content="VMware"><meta name="author" content="gaoshuai,gaoshuais@126.com"><meta name="copyright" content="gaoshuai"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="vSAN磁盘offline场景操作建议指导前言目前vSAN现网维护的过程中，经常收到客户反馈vSAN集群发生磁盘offline，具体表现为RAID卡发送命令超时、磁盘组性能下降导致业务io卡顿、磁盘出现故障导致踢盘等，当磁盘offline情况严重时会影响客户业务稳定性甚至数据可用性，因此本指导书主要针对vSAN磁盘offline这类场景给出通用的定界定位方法、测试方案及建议。 踢盘问题定界定位流程">
<meta property="og:type" content="article">
<meta property="og:title" content="vSAN磁盘offline场景操作建议指导">
<meta property="og:url" content="https://www.gaoshuais.top/posts/4901/index.html">
<meta property="og:site_name" content="HILL">
<meta property="og:description" content="vSAN磁盘offline场景操作建议指导前言目前vSAN现网维护的过程中，经常收到客户反馈vSAN集群发生磁盘offline，具体表现为RAID卡发送命令超时、磁盘组性能下降导致业务io卡顿、磁盘出现故障导致踢盘等，当磁盘offline情况严重时会影响客户业务稳定性甚至数据可用性，因此本指导书主要针对vSAN磁盘offline这类场景给出通用的定界定位方法、测试方案及建议。 踢盘问题定界定位流程">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://www.gaoshuais.top/img/head.jpg">
<meta property="article:published_time" content="2022-04-19T12:36:28.000Z">
<meta property="article:modified_time" content="2022-04-19T13:36:55.404Z">
<meta property="article:author" content="gaoshuai">
<meta property="article:tag" content="VMware">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://www.gaoshuais.top/img/head.jpg"><link rel="shortcut icon" href="/img/head.jpg"><link rel="canonical" href="https://www.gaoshuais.top/posts/4901/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'vSAN磁盘offline场景操作建议指导',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-04-19 21:36:55'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><link rel="stylesheet" href="/css/staticbutterfly.css"><link rel="stylesheet" href="/css/waifu1.css"><link rel="stylesheet" href="/css/flat-ui.min.css"><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="HILL" type="application/atom+xml">
</head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/head.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">23</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">8</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于&amp;留言板</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">HILL</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于&amp;留言板</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">vSAN磁盘offline场景操作建议指导</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-04-19T12:36:28.000Z" title="发表于 2022-04-19 20:36:28">2022-04-19</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-04-19T13:36:55.404Z" title="更新于 2022-04-19 21:36:55">2022-04-19</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="vSAN磁盘offline场景操作建议指导"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="vSAN磁盘offline场景操作建议指导"><a href="#vSAN磁盘offline场景操作建议指导" class="headerlink" title="vSAN磁盘offline场景操作建议指导"></a>vSAN磁盘offline场景操作建议指导</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>目前vSAN现网维护的过程中，经常收到客户反馈vSAN集群发生磁盘offline，具体表现为RAID卡发送命令超时、磁盘组性能下降导致业务io卡顿、磁盘出现故障导致踢盘等，当磁盘offline情况严重时会影响客户业务稳定性甚至数据可用性，因此本指导书主要针对vSAN磁盘offline这类场景给出通用的定界定位方法、测试方案及建议。</p>
<h2 id="踢盘问题定界定位流程"><a href="#踢盘问题定界定位流程" class="headerlink" title="踢盘问题定界定位流程"></a>踢盘问题定界定位流程</h2><h3 id="问题现象及告警"><a href="#问题现象及告警" class="headerlink" title="问题现象及告警"></a>问题现象及告警</h3><p>踢盘现象通常代表相关磁盘处于absent或者degrade的状态，产生的原因有很多，例如磁盘硬件故障、磁盘物理拔出、主机上下电、磁盘容量已满等，判断该问题是否是由于IO超时导致须综合多方面因素来分析。当vSAN集群出现磁盘offline时，客户现场可以从监控页面、vCenter后台、RAID卡信息等多个层面查看是否有异常告警。</p>
<h4 id="监控页面告警"><a href="#监控页面告警" class="headerlink" title="监控页面告警"></a>监控页面告警</h4><p>首先客户的vSphere Client监控页面上一定会发出“Errors occurred on the disks of a vSAN host”的告警，如下图：</p>
<img src="/posts/4901/zh-cn_image_0000001115391425.png" class="">

<p>此外，“Configure”选项卡的“Disk management”可查看集群中的一台或多台主机上会出现磁盘组状态为“Unhealthy”，如下图：</p>
<img src="/posts/4901/zh-cn_image_0000001115186897.png" class="">

<h4 id="vCenter后端告警"><a href="#vCenter后端告警" class="headerlink" title="vCenter后端告警"></a>vCenter后端告警</h4><p>直接登录vCenter虚拟机后台上也可以观察踢盘现象，通过调用vSphere控制台命令行工具（rvc），首先在诊断项“Physical disk”可以看到所有故障磁盘涉及的主机、磁盘id等信息，如下图：</p>
<img src="/posts/4901/zh-cn_image_0000001115549907.png" class="">

<p>此外，为了评估offline磁盘是否对客户业务造成影响，在状态检查项中检查是否有不可访问的虚拟机或者数据对象，如下图：</p>
<img src="/posts/4901/zh-cn_image_0000001115326953.png" class="">

<h4 id="RAID卡信息告警"><a href="#RAID卡信息告警" class="headerlink" title="RAID卡信息告警"></a>RAID卡信息告警</h4><p>当发生磁盘踢盘时，RAID卡的alilog日志中也通常会出现CO:FPE TW b开头的告警信息，并伴随有Command timeout，如下图：</p>
<img src="/posts/4901/zh-cn_image_0000001115391429.png" class="">

<h4 id="告警分析"><a href="#告警分析" class="headerlink" title="告警分析"></a>告警分析</h4><p>如果vSAN集群中发生了由于IO超时导致的踢盘故障并影响到客户虚拟机业务时，以上<a target="_blank" rel="noopener" href="https://support-it.huawei.com/docs/zh-cn/typical-scenarios-1/server-knowledgebase/zh-cn_topic_0000001115186857.html">监控页面告警</a>~<a target="_blank" rel="noopener" href="https://support-it.huawei.com/docs/zh-cn/typical-scenarios-1/server-knowledgebase/zh-cn_topic_0000001115186859.html">RAID卡信息告警</a>的所有现象和日志信息都应该是必现的；但在实际处理现网问题过程中，由于客户有时不能及时察觉导致重要告警信息被忽略、客户监控页面不能截图等种种原因，通常不能收集充分的信息，在这种情况下就需要通过能够长时间保存的日志来定位问题，例如主机上的vobd.log和RAID卡日志，其中RAID卡日志最能够说明是否出现IO超时，而vobd.log中可以捕获到很长时间范围内的磁盘踢盘现象。</p>
<h3 id="日志收集"><a href="#日志收集" class="headerlink" title="日志收集"></a>日志收集</h3><p>本章节主要介绍vSAN系统日志和RAID卡日志收集步骤，如还需收集系统性能日志信息可参考《<a target="_blank" rel="noopener" href="https://support-it.huawei.com/docs/zh-cn/typical-scenarios-1/server-knowledgebase/zh-cn_topic_0000001117328489.html">vSAN系统日志收集指导</a>》。</p>
<h4 id="系统日志收集"><a href="#系统日志收集" class="headerlink" title="系统日志收集"></a>系统日志收集</h4><p>vSAN现网问题分析最重要的系统日志包括ESXi主机上的vm-support日志和vCenter上的vc-support日志，主要功能如下表：</p>
<table>
<thead>
<tr>
<th>序号</th>
<th>名称</th>
<th>用途</th>
<th>必要性</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>主机vm-support日志</td>
<td>从主机层面查看vSAN节点状态</td>
<td>高</td>
</tr>
<tr>
<td>2</td>
<td>集群vc-support日志</td>
<td>从集群层面查看vSAN整体状态</td>
<td>高</td>
</tr>
</tbody></table>
<ul>
<li><p>vm-support日志收集</p>
<p>通过SSH方式登录ESXi主机后台，直接执行<strong>vm-support</strong>命令，系统会在默认路径下自动生成一个后缀为.tgz的日志压缩包，如下图所示：</p>
<img src="/posts/4901/zh-cn_image_0000001115186899.png" class=""></li>
<li><p>vc-support日志收集</p>
<p>该日志的收集方式与主机日志收集方式非常相似，首先通过SSH方式登录vCenter虚拟机后台，直接执行<strong>vc-support</strong>命令即可，系统会在默认路径下生产一个后缀为.tgz的日志压缩包，由于一个集群只有一个vcenter，因此无论集群中有多少台主机，只需要收集一份该日志即可，如下图所示：</p>
<img src="/posts/4901/zh-cn_image_0000001115549909.png" class=""></li>
</ul>
<h4 id="RAID卡日志收集"><a href="#RAID卡日志收集" class="headerlink" title="RAID卡日志收集"></a>RAID卡日志收集</h4><ul>
<li>预置工具：博通RAID卡工具storcli64，具体下载及使用方法请参照《<a target="_blank" rel="noopener" href="https://support.huawei.com/enterprise/zh/doc/EDOC1000163568">华为V5服务器 RAID控制卡 用户指南</a>》——OS命令行工具。</li>
<li>使用方法：在OS下使用storcli64工具收集RAID卡日志并重定向至文件，具体命令为storcli64 /c*<strong>controller_id*</strong> show alilog &gt; *<strong>file_name*</strong></li>
</ul>
<table>
<thead>
<tr>
<th>参数</th>
<th>参数说明</th>
<th>取值</th>
</tr>
</thead>
<tbody><tr>
<td>*<strong>Controller_id*</strong></td>
<td>控制器ID</td>
<td>默认从0开始</td>
</tr>
<tr>
<td>*<strong>File_name*</strong></td>
<td>重定向的文件名称</td>
<td>自定义</td>
</tr>
</tbody></table>
<img src="/posts/4901/zh-cn_image_0000001115549911.png" class="">

<h4 id="iBMC硬件日志收集"><a href="#iBMC硬件日志收集" class="headerlink" title="iBMC硬件日志收集"></a>iBMC硬件日志收集</h4><p>此外，该类场景下可能还会涉及硬件问题，硬件iBMC日志一键收集可参考链接：</p>
<p><a target="_blank" rel="noopener" href="http://3ms.huawei.com/km/groups/1004825/blogs/details/8189905">http://3ms.huawei.com/km/groups/1004825/blogs/details/8189905</a></p>
<h3 id="集群信息检查"><a href="#集群信息检查" class="headerlink" title="集群信息检查"></a>集群信息检查</h3><p>在分析任何的vSAN现网问题时，首先需要对集群的节点配置有整体了解，通过<a target="_blank" rel="noopener" href="https://support-it.huawei.com/docs/zh-cn/typical-scenarios-1/server-knowledgebase/zh-cn_topic_0000001115186863.html">系统日志收集</a>收集的vc-support日志可以查看集群和主机视图、集群所有磁盘信息、是否不可用的虚拟机或对象、是否存在大量数据重建io等。解压vc-support日志包，然后进入commands目录，打开日志文件python_usrlibvmware-vpxvsan-healthvsan-vc-health-statuspy-rvc-basic-support-information.txt即可查看，如下所示：</p>
<img src="/posts/4901/zh-cn_image_0000001115326955.png" class="">

<h3 id="集群健康状态诊断"><a href="#集群健康状态诊断" class="headerlink" title="集群健康状态诊断"></a>集群健康状态诊断</h3><p>获取集群基本信息后，下一步须检查集群存在哪些异常告警，通过查看vc-support日志的commands目录下python_usrlibvmware-vpxvsan-healthvsan-vc-health-statuspy-cluster-health.txt文件可以对日志收集时间点的集群状态进行完全的健康诊断，即集群在那一刻的所有异常告警最终都会反映在该日志文件中，用户可根据给出的告警信息缩小故障主机范围，并进一步通过主机日志去分析根因。</p>
<p>但该日志文件格式较复杂，例如查看到一些磁盘状态处于absent，如下图所示：</p>
<img src="/posts/4901/zh-cn_image_0000001115391431.png" class="">

<p>如上图所示，该日志维护人员难以阅读，因此需要采用可视化工具进行分析，具体详情可参考<a target="_blank" rel="noopener" href="https://support-it.huawei.com/docs/zh-cn/typical-scenarios-1/server-knowledgebase/zh-cn_topic_0000001115326921.html">集群日志分析可视化工具</a>。</p>
<h3 id="集群日志分析可视化工具"><a href="#集群日志分析可视化工具" class="headerlink" title="集群日志分析可视化工具"></a>集群日志分析可视化工具</h3><p>目前在黄区测试环境部署了一套vSAN日志分析可视化工具，目前已实现的功能是通过vc-support日志对集群健康状态进行诊断，包括集群信息获取和集群所有异常进行检测，链接：<a target="_blank" rel="noopener" href="http://10.70.222.85:5000/%EF%BC%8C%E9%A6%96%E9%A1%B5%E5%B1%95%E7%A4%BA%E5%A6%82%E4%B8%8B%EF%BC%9A">http://10.70.222.85:5000/，首页展示如下：</a></p>
<img src="/posts/4901/zh-cn_image_0000001115186903.png" class="">

<p>需要上传的日志文件如图中红色框所示，通过上传集群配置日志，可以获取集群视图、磁盘、故障虚拟机等信息；通过上传健康状态日志，可以获取当前集群所有告警项及告警原因，示例如下图：</p>
<img src="/posts/4901/zh-cn_image_0000001115326957.png" class="">

<img src="/posts/4901/zh-cn_image_0000001115391433.png" class="">

<h3 id="IO超时原因定界"><a href="#IO超时原因定界" class="headerlink" title="IO超时原因定界"></a>IO超时原因定界</h3><p>上一章节中已描述了通过对集群状态的诊断可以确定故障节点，本章节介绍在故障主机中针对IO超时问题的日志分析方法。</p>
<h4 id="系统日志分析"><a href="#系统日志分析" class="headerlink" title="系统日志分析"></a>系统日志分析</h4><p>系统日志分析通常需要收集vm-support日志和vc-support日志，本章节以刚果项目超时问题为例，由于之前故障时未采集vc-support日志，因此先从vm-support日志进行分析，截图日志来源于4月25日刚果发生故障的主机。</p>
<h5 id="vm-support日志包结构"><a href="#vm-support日志包结构" class="headerlink" title="vm-support日志包结构"></a>vm-support日志包结构</h5><p>vm-support是在每一台主机上收集的压缩包，记录了该主机在一定时间段的所有相关信息，是分析出问题根因的重要文件，基本结构如下图：</p>
<img src="/posts/4901/zh-cn_image_0000001115549915.png" class="">

<p>整个vm-support压缩包大小从几百M到几个G，大约包含几千个文件，其中最主要的日志目录是上图中的commmands和var，commands目录下主要包含了绝大多数的主机配置信息，var目录下主要包含了主机日志文件。</p>
<h5 id="vobd-log分析"><a href="#vobd-log分析" class="headerlink" title="vobd.log分析"></a>vobd.log分析</h5><p>vobd日志捕获VMkernel中的重要事件，如果发生磁盘掉盘以及超时故障，最容易发现此告警的就是通过vobd.log文件，该文件的目录路径为：</p>
<img src="/posts/4901/zh-cn_image_0000001115326959.png" class="">

<p>如果发生了IO超时导致的踢盘，可以看到大量的Power-on Reset、under permanent error以及“vSAN device XXXX has gone offline”等信息：</p>
<img src="/posts/4901/zh-cn_image_0000001115391437.png" class="">

<img src="/posts/4901/zh-cn_image_0000001115186905.png" class="">

<p>VMkernel.log分析</p>
<p>VMkernel.log是ESXi主机的核心日志文件，记录了包括设备发现、存储和网络设备、驱动程序事件以及虚拟机启动等所有相关信息，是日志分析中排查底层问题最重要的依据，该文件的目录路径为：</p>
<img src="/posts/4901/zh-cn_image_0000001115549917.png" class="">

<p>如果发生了IO超时导致的踢盘，该文件中依然可以看到Power-on Reset等告警信息以及告警发生过程及原因，截图如下：</p>
<img src="/posts/4901/zh-cn_image_0000001115326963.png" class="">

<ul>
<li>上图中，首先lsi_mr3报出0x10c，之前VMware工程师针对该错误码已给出过提示，该信息属于严重错误；目前的测试结果是当出现IO超时该错误码必定会出现，但0x10c是由VMware定义的驱动程序的事件码，包含的故障类型可能不仅限于这一类问题，因此反过来不一定能成立，暂时只可作为IO超时的参考标识。</li>
<li>1号红色框部分代表表示基于SCSI协议的命令下发到磁盘naa.55cd2e414fc9857a的返回码，其中H:0xc表示发生临时错误，该io命令会重新下发（详情见<a target="_blank" rel="noopener" href="https://support-it.huawei.com/docs/zh-cn/typical-scenarios-1/server-knowledgebase/zh-cn_topic_0000001115186869.html">VMkernel.log的SCSI码解析</a>）。</li>
<li>第2个红色框部分表示基于SCSI协议的命令下发到容量盘naa.55cd2e414fc97688的返回码，其中D:0x2表示状态码异常，因此后面的sense data的三个字节是有效的，对应的0x6 0x29 0x00代表发生了POR或者磁盘重启（详情见<a target="_blank" rel="noopener" href="https://support-it.huawei.com/docs/zh-cn/typical-scenarios-1/server-knowledgebase/zh-cn_topic_0000001115391397.html">VMkernel.log分析</a>）。</li>
<li>第3个红色框部分直接给出容量盘naa.55cd2e414fc97688发生了reset的提示。</li>
</ul>
<p>除上面截图外，该日志的其他地方还出现了类似的大量的SCSI错误返回码，且从时间上看基本上都是基于lsi_mr3报出的错误引入，例如下图：</p>
<img src="/posts/4901/zh-cn_image_0000001115391439.png" class="">

<p>综合推断正是之前RAID卡的驱动程序发生异常，导致了当前RAID卡发送到对应磁盘的<strong>io</strong>命令Cmd 0xxxxx失败，导致磁盘不断reset。</p>
<h5 id="VMkernel-log的SCSI码解析"><a href="#VMkernel-log的SCSI码解析" class="headerlink" title="VMkernel.log的SCSI码解析"></a>VMkernel.log的SCSI码解析</h5><p>由于集群采用的磁盘都是SAS盘，所有RAID卡到磁盘的命令下发都是基于SCSI协议进行编码，因此本章节主要介绍如何解析VMkernel文件中的SCSI返回码，属于对<a target="_blank" rel="noopener" href="https://support-it.huawei.com/docs/zh-cn/typical-scenarios-1/server-knowledgebase/zh-cn_topic_0000001115391397.html">VMkernel.log分析</a>的补充。</p>
<p>以<a target="_blank" rel="noopener" href="https://support-it.huawei.com/docs/zh-cn/typical-scenarios-1/server-knowledgebase/zh-cn_topic_0000001115391397.html">VMkernel.log分析</a>中H:0x7 D:0x40 P:0x0 Invalid sense data: 0x0 0x0 0x0为例进行说明，H开头的字节为主机码，D开头的字节为状态码，P开头的表示插件码，sense data的第1个字节为sense key,后面两个字节为additional sense data。</p>
<p>主机码的信息主要反映了RAID卡的驱动或固件，H:0x7代表检测到主机RAID卡发生了内部错误，VMware 官网kb解释如下图：</p>
<img src="/posts/4901/zh-cn_image_0000001115186907.png" class="">

<p>状态码是在单条IO命令执行完毕了才会返回，反应了命令执行的基本情况，通常为D:0x2时表示命令执行异常，此时才需要检查后面的sense data的三个字节，如果不为D:0x2则后面3个字节是无效的，例如示例中时0x40，表明任务强制abort，官网kb如下图：</p>
<img src="/posts/4901/zh-cn_image_0000001115326965.png" class="">

<p>Sense key主要用于指示命令执行失败的原因，只有在状态码为0x2（CHECK CONDITION）时才有效；而最后两个字节描述了该原因的详情，官网kb如下图：</p>
<img src="/posts/4901/zh-cn_image_0000001115549919.png" class="">

<p>SCSI码相关信息的VMware链接：<a target="_blank" rel="noopener" href="https://kb.vmware.com/s/article/289902?lang=en_US">https://kb.vmware.com/s/article/289902?lang=en_US</a></p>
<p>SCSI Addition Sense Data链接：<a target="_blank" rel="noopener" href="https://www.t10.org/lists/2asc.htm">https://www.t10.org/lists/2asc.htm</a></p>
<h5 id="VMkwarning-log分析"><a href="#VMkwarning-log分析" class="headerlink" title="VMkwarning.log分析"></a>VMkwarning.log分析</h5><p>VMkwarning.log文件主要捕获主机中的所有告警信息，其中会包含vSAN设备的permenant error、vSAN软件错误以及RAID卡错误，可作为对vobd和VMkernel日志的补充验证，故障时间段截取的信息如下图所示：</p>
<img src="/posts/4901/zh-cn_image_0000001115391443.png" class="">

<p>上图中，lsi_mr3驱动报出了IO返回错误、以及对应的cmd序号和状态码；第1个红色框表示RAID卡下发到磁盘naa.55cd2e414fc9609f的命令出错，系统重新监测命令下发通道是否正常；第2个红色框表示多个vSAN设备掉盘。</p>
<h4 id="RAID卡日志分析"><a href="#RAID卡日志分析" class="headerlink" title="RAID卡日志分析"></a>RAID卡日志分析</h4><p>RAID卡日志包含了RAID卡运行过程中事件的全部信息，在日志较大的情况下，先根据问题发生的时间点来对应日志中对应的事件范围。值得注意的是，RAID卡内部有独立的计时器，日志上的时间与真实时间并不是直接对应，需要通过查询所在环境的RAID卡时间与真实时间的差，来反推在日志时间中的真实范围。</p>
<p>如：当前时间为2021/1/8 08:09，查询系统时间及RAID卡时间如下，即RAID卡时间与真实事件有约5小时的时差，而在查询日志事件时则需要往后计算5小时。</p>
<img src="/posts/4901/zh-cn_image_0000001115326967.png" class="">

<img src="/posts/4901/zh-cn_image_0000001115391445.png" class="">

<p>在RAID卡日志中，值得注意的异常事件常见有四类，对应的解析与日志记录如下：</p>
<ul>
<li><p>返回Unexpected sense</p>
<img src="/posts/4901/zh-cn_image_0000001115186913.png" class="">

<p>当scsi设备进入SCSI contingent allegiance condition时，Scsi initiator会下发相应的requeset sense至scsi设备，同时返回对应的sense key。根据sense key，则可对此时scsi设备的状态进行判断。Sense key的解析可参考SCSI_Primary_Commands(SPC-4).pdf及<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Key_Code_Qualifier%E3%80%82">https://en.wikipedia.org/wiki/Key_Code_Qualifier。</a></p>
</li>
<li><p>IO超时</p>
<img src="/posts/4901/zh-cn_image_0000001115549921.png" class="">

<p>当RAID卡与硬盘的通讯发生IO超时，则RAID卡日志中有以上事件记录，关键字为command timeout，同时还会记录超时对应的CDB命令。在某些情况下，还会记录对应的sense key。</p>
<p>当有以上事件发生时，可认为RAID卡与硬盘之间的通讯出现了问题。</p>
<p>以上述日志事件记录为例，CDB以28开头对应为read事件，即RAID卡对s5槽位硬盘读取时发生了IO超时。</p>
</li>
<li><p>链路重置</p>
<img src="/posts/4901/zh-cn_image_0000001115326969.png" class="">

<p>当RAID卡诊断与某个硬盘的通讯链路存在问题时，即会尝试对该硬盘的链路进行重置。此时RAID卡对硬盘下发comreset命令，在硬盘收到后，链路发生重置，硬盘与RAID卡之间重新建链。这时候则需考虑链路或者硬盘是否存在异常。</p>
</li>
<li><p>踢盘</p>
<img src="/posts/4901/zh-cn_image_0000001115391447.png" class="">

<p>踢盘操作与普通拔盘操作在RAID卡日志中都会被记录为removed字样的事件，二者的区分主要根据以下几点：</p>
<ul>
<li><p>知道踢盘发生的准确时间点，即此时的removed事件为踢盘操作。</p>
</li>
<li><p>在相同的时间点下，BMC中没有对应槽位盘removed的事件记录，即为踢盘。</p>
</li>
<li><p>踢盘操作前该槽位的硬盘存在异常行为，如io超时和链路重置，以及RAID卡将该盘的状态转化为UBAD。</p>
</li>
</ul>
</li>
</ul>
<h4 id="分析结论"><a href="#分析结论" class="headerlink" title="分析结论"></a>分析结论</h4><p>综合分析故障时收集到的日志，可得出以下几点结论：</p>
<ul>
<li>在客户故障时间点确实产生了大量的链路重置和磁盘reset信息，且全部伴随着RAID驱动发出的lsi_mr3错误事件码0x10c。</li>
<li>从RAID卡和磁盘通信过程中的SCSI返回码来分析，结合VMware官网kb给出的提示，故障的直接原因可以确定是RAID卡发生internal error导致，诱因通常是驱动、固件或者硬件本身。</li>
</ul>
<p>客户升级到3408卡最新版的驱动7.713后并未出现超时，目前判断问题的原因很可能是旧版驱动7.703和7.706存在bug。此外，最早的驱动版本7.703和固件版本2139的组合未做过兼容性认证，业界使用的也比较少，后续应该尽量使用和业界厂商一致的组合，这样如果再出现问题就可以向RAID卡厂商寻求很多支持，降低使用非常规的组合配置带来的维护风险。</p>
<h3 id="兼容性原因定界"><a href="#兼容性原因定界" class="headerlink" title="兼容性原因定界"></a>兼容性原因定界</h3><h4 id="通过VCG查询vSAN部件兼容性"><a href="#通过VCG查询vSAN部件兼容性" class="headerlink" title="通过VCG查询vSAN部件兼容性"></a>通过VCG查询vSAN部件兼容性</h4><p>用于部署VSAN的所有部件（存储控制器、HDD 和 SSD ，包括PCIe SSD和NVMe SSD）都必须在 VMware VSAN硬件兼容性列表上。使用未经认证的硬件以及驱动/固件版本可能导致出现性能问题或者数据丢失。VMware无法对运行于未经认证的硬件上的环境提供支持。由于存储控制器等部件的驱动和固件是存在配套关系的，需要确保对应驱动和固件始终是VMware VSAN硬件兼容性列表上兼容的最新认证版本，因此首先根据客户反馈的环境信息，检测RAID卡和磁盘是否在vSAN兼容性列表中。通用查询步骤如下：</p>
<ol>
<li><p>访问VMware VSAN兼容性查询页面：</p>
<p><a target="_blank" rel="noopener" href="http://www.vmware.com/resources/compatibility/search.php?deviceCategory=vsan">http://www.vmware.com/resources/compatibility/search.php?deviceCategory=vsan</a></p>
</li>
<li><p>点击“***Build Your Own based on Certified Components***”即可切换到VSAN Certified Components查询页面。</p>
<img src="/posts/4901/zh-cn_image_0000001115186915.png" class=""></li>
<li><p>RAID卡查询以SR120为例，在<em><strong>Search For：*<strong>栏选择*</strong>IO Controller**<em>；在</em></strong>Brand Name：*<strong>栏选择“</strong></em>Huawei Technologies Co. Ltd.*<strong>”，然后点击*</strong>Update and View Results***即可查询相应通过认证的RAID卡。</p>
<img src="/posts/4901/zh-cn_image_0000001115186917.png" class=""></li>
<li><p>点击搜索到的SR 120，进入后选择需要的OS版本，然后可以查询到该RAID卡支持的驱动和固件版本。</p>
<img src="/posts/4901/zh-cn_image_0000001115186919.png" class=""></li>
<li><p>磁盘查询以SSD Intel3500为例，在<em><strong>Search For：*<strong>栏选择*</strong>SSD**<em>；在</em></strong>Partners：*<strong>栏选择相应SSD盘厂商，然后点击</strong></em>Update and View Results***即可查询相应通过认证的SSD。</p>
<img src="/posts/4901/zh-cn_image_0000001115549927.png" class=""></li>
</ol>
<h4 id="通过可视化工具查询兼容性"><a href="#通过可视化工具查询兼容性" class="headerlink" title="通过可视化工具查询兼容性"></a>通过可视化工具查询兼容性</h4><p>除了上一章节中的利用VMware官网VCG进行查询外，还可以利用<a target="_blank" rel="noopener" href="https://support-it.huawei.com/docs/zh-cn/typical-scenarios-1/server-knowledgebase/zh-cn_topic_0000001115326921.html">集群日志分析可视化工具</a>中介绍的可视化工具进行快速分析，首先上传集群诊断日志，如果存在兼容性问题则可以在“集群诊断详情”中看到兼容性情况，如果没有兼容性问题则不会有对应告警。</p>
<img src="/posts/4901/zh-cn_image_0000001115549929.png" class="">

<h3 id="硬件类原因定界"><a href="#硬件类原因定界" class="headerlink" title="硬件类原因定界"></a>硬件类原因定界</h3><p>如果是硬件类故障，除了从系统日志分析外，主要还得通过查看iBMC硬件日志进行分析，主要查看底层硬盘日志是否有报错。硬件类日志分析文档在3ms博客上已有很多，这里不再介绍，可参照以下链接：</p>
<p><a target="_blank" rel="noopener" href="http://3ms.huawei.com/km/blogs/details/8253115">http://3ms.huawei.com/km/blogs/details/8253115</a></p>
<p><a target="_blank" rel="noopener" href="http://3ms.huawei.com/km/blogs/details/5292253">http://3ms.huawei.com/km/blogs/details/5292253</a></p>
<h3 id="软件类及其它原因定界"><a href="#软件类及其它原因定界" class="headerlink" title="软件类及其它原因定界"></a>软件类及其它原因定界</h3><p>实际处理现网问题过程中，存在一部分故障是由于vSAN系统版本、组件或者网络导致的，这类故障的处理不在华为公司的责任范围内，需要告诉客户向VMware公司进行求助。这类问题的定位主要可以通过vc-support日志进行排查。</p>
<h4 id="vc-support日志概述"><a href="#vc-support日志概述" class="headerlink" title="vc-support日志概述"></a>vc-support日志概述</h4><p>在收集客户日志信息时，很多客户集群的主机数量较多，且每台主机的vm-support日志又较大，所以维护人员通常只能收集到其中几台主机的日志，因此非常有必要通过收集集群整体状态相关的日志来快速对集群进行诊断。由于一个集群只有一个vcenter，因此无论集群中有多少台主机，只需要收集一份该日志即可。</p>
<h4 id="vc-support日志包结构"><a href="#vc-support日志包结构" class="headerlink" title="vc-support日志包结构"></a>vc-support日志包结构</h4><p>vc-support日志解压后的目录结构如下图：其中最主要的日志目录是commmands和var，commands目录下主要包含了绝大多数的集群配置信息，var目录下主要包含了vcenter采集到的各类日志文件。</p>
<img src="/posts/4901/zh-cn_image_0000001115326973.png" class="">

<h4 id="vmware-vsan-health-summary-result-log日志分析"><a href="#vmware-vsan-health-summary-result-log日志分析" class="headerlink" title="vmware-vsan-health-summary-result.log日志分析"></a>vmware-vsan-health-summary-result.log日志分析</h4><p>vmware-vsan-health-summary-result.log通常可以保存较长时间范围内集群发生的所有告警信息，该文件大概有几百个压缩包，该日志的路径如下图所示：</p>
<img src="/posts/4901/zh-cn_image_0000001115391449.png" class="">

<p>用户可以根据故障发生的时间去寻找对应时间范围的压缩包，并搜索相应的告警。</p>
<img src="/posts/4901/zh-cn_image_0000001115326975.png" class="">

<p>如上图所示，三个红色框给出了物理磁盘、数据对象和内部组件的告警信息，然后根据具体描述去分析故障发生过程。</p>
<h4 id="vpxd-log日志分析"><a href="#vpxd-log日志分析" class="headerlink" title="vpxd.log日志分析"></a>vpxd.log日志分析</h4><p>vpxd.log属于vCenter的主日志，包含所有 vSphere Client 和 WebServices 连接、内部任务和事件以及与受管 ESXi/ESX 主机上的 vCenter Server Agent进行的通信，日志文件路径如下图所示：</p>
<img src="/posts/4901/zh-cn_image_0000001115186921.png" class="">

<img src="/posts/4901/zh-cn_image_0000001115549931.png" class="">

<p>以上图为例，图中的3个红色框分别给出了主机host-23的FDM状态变化、主机上对应的虚拟机故障迁移、异常发生的原因等；此外，可联合其它日志对同一故障时间范围内的问题原因进行定位。</p>
<h2 id="问题复现测试方案"><a href="#问题复现测试方案" class="headerlink" title="问题复现测试方案"></a>问题复现测试方案</h2><h3 id="测试背景和目标"><a href="#测试背景和目标" class="headerlink" title="测试背景和目标"></a>测试背景和目标</h3><p>2020年4月刚果客户vSAN集群发生磁盘踢盘现象，且出现虚拟机故障并伴有大量的数据同步io，后来通过连续升级RAID卡3408的驱动后，该问题未再出现。为了分析故障原因及RAID卡驱动对于集群性能的影响，在实验室环境中搭建vSAN集群，并采用客户故障现场一致的OS、RAID卡型号及驱动版本，通过模拟各种IO模型来触发磁盘IO超时及踢盘现象。</p>
<h3 id="测试工具介绍"><a href="#测试工具介绍" class="headerlink" title="测试工具介绍"></a>测试工具介绍</h3><p>为了在实验室环境模拟客户现场踢盘故障，需要模拟各种常用类型的业务负载，业界常用的IO工作负载生成器有fio、vdbench等，而针对vSAN存储系统，VMware推出了专门的存储性能自动化测试工具HCIbench，架构图如下：</p>
<img src="/posts/4901/zh-cn_image_0000001115326977.png" class="">

<p>HCIbench其实也是通过调用fio等测试工具实现集群性能测试自动化，用户只须在测试前指定需要运行测试的参数，HCIbench就会在测试时自动创建虚拟机，完全自动化地实现端到端的虚拟机部署、测试、协调负载运行并汇总测试结果，因此后面测试执行过程也基于HCIbench来介绍。</p>
<h3 id="测试环境配置"><a href="#测试环境配置" class="headerlink" title="测试环境配置"></a>测试环境配置</h3><p>为模拟客户现场故障，首先需要收集的客户信息主要包括两个方面：集群配置信息、故障前后操作及状态信息。</p>
<p>由于客户现场故障发生时间距离测试时间较旧，很多信息无法通过客户直接获得，因此目前当前信息主要通过收集的vm-support日志来获取，客户现场配置信息如下：</p>
<img src="/posts/4901/zh-cn_image_0000001115391453.png" class="">

<p>实验室环境所用的OS版本和RAID卡型号与客户保持一致，磁盘模型选用了基于全闪存的SAS华为盘+SATA Intel盘；此外为了尽可能降低磁盘组性能以便于复现，还另外测试了基于混合模式的SAS华为盘+SATA 华为盘，实验室配置信息如下：</p>
<img src="/posts/4901/zh-cn_image_0000001115549933.png" class="">

<h3 id="IO负载规划依据"><a href="#IO负载规划依据" class="headerlink" title="IO负载规划依据"></a>IO负载规划依据</h3><h4 id="测试思路"><a href="#测试思路" class="headerlink" title="测试思路"></a>测试思路</h4><p>整体测试思路如下图所示，由于集群初始状态未知，且从RAID卡错误日志中无法直接得出客户现场故障的诱因，因此尝试分别从性能测试瓶颈、故障场景模拟等边界去触发磁盘故障踢盘。</p>
<img src="/posts/4901/zh-cn_image_0000001115326979.png" class="">

<h4 id="IO性能指标及负载组合"><a href="#IO性能指标及负载组合" class="headerlink" title="IO性能指标及负载组合"></a>IO性能指标及负载组合</h4><p>IO负载测试时需要模拟尽可能大的负载，常用的性能指标有IOPS、Throughput（吞吐量）和latency（延迟）。因此如果要从性能角度测出vSAN集群的边界值，就需要从以上三个方面分别规划IO模型。</p>
<p>根据HCIbench官网的负载模型介绍，针对不同的性能指标须对应不同的负载组合，典型HCIbench参数表配置基准如下表：</p>
<img src="/posts/4901/zh-cn_image_0000001115186925.png" class="">

<img src="/posts/4901/zh-cn_image_0000001115549935.png" class="">

<p>官方推荐的性能调优方式如上，在各性能指标的配置基准上，单调调整其中一项参数即可提高测试结果的单一性能指标值。</p>
<h4 id="故障场景模拟"><a href="#故障场景模拟" class="headerlink" title="故障场景模拟"></a>故障场景模拟</h4><p>由于客户现场发生磁盘offline现象时不确定集群处于何种状态，因此模拟一些常用的故障场景，并在这些故障场景下尝试触发Power-on Reset告警。</p>
<ul>
<li><p>磁盘故障及模拟</p>
<p>容量盘或缓存盘故障是任何存储环境中最常见的故障，其中容量盘故障只影响单块磁盘数据，而缓存盘故障会影响整个磁盘组所有数据，当故障磁盘上的组件超过1个小时后集群会重新发起组件重构，集群中会产生一定的重建数据IO，但所有的虚拟机及数据可用性不会受影响。如果要模拟该故障直接拔出测试磁盘即可。</p>
</li>
<li><p>主机故障及模拟</p>
<p>主机故障发生后，主机上所有磁盘组的数据都会不可用，如果超过1个小时后主机依然未能恢复，则集群中将会发起大量重建数据IO，在3节点的集群中，如果单节点主机故障不会影响虚拟机及数据可用性，但重建的数据IO会占用大量网络带宽，会影响业务IO吞吐量。如果要模拟该故障可以将单台主机断开（网络断开或者电源断开）。</p>
</li>
<li><p>磁盘容量超载及模拟</p>
<p>磁盘容量超过阈值时，集群会自动进行数据重平衡操作，此时集群中也会产生大量数据io；此外，如果某些磁盘已经完全被写满时，vSAN集群会暂停对这些磁盘的发出写请求的虚拟机，即这部分虚拟机会变得不可用。如果要模拟该故障可以在配置HCIbench参数时适当增大虚拟机数量和磁盘大小使之超出集群容量阈值。</p>
</li>
</ul>
<h4 id="IO负载测试参数"><a href="#IO负载测试参数" class="headerlink" title="IO负载测试参数"></a>IO负载测试参数</h4><p>IO工作负载的测试参数除了<a target="_blank" rel="noopener" href="https://support-it.huawei.com/docs/zh-cn/typical-scenarios-1/server-knowledgebase/zh-cn_topic_0000001115549893.html">IO性能指标及负载组合</a>中的基本参数配置外，常用的还包括块尺寸、读写比例、随机性、工作集大小、队列深度等，针对常用的业务负载模型，HCIbench官网也给出了基准配置建议，如下图：</p>
<img src="/posts/4901/zh-cn_image_0000001115391455.png" class="">

<p>其中，现实中最常见的测试参数为快尺寸=4k，70%比例读，100%随机性，大部分的web应用就可以归到这一类中；像OLTP这类的业务类型，就可以采用快尺寸=8k，50%比例读，100%随机性来模拟；如果要追求最大吞吐量，就可以增加块尺寸，并以顺序写的方式来执行测试。</p>
<p>以上给出的是官方提供的一些常用经验，可以作为调试参数的参考基准，在实际测试过程中应根据需求适当调整，得出的结论以实际测试结果为准。</p>
<h4 id="测试执行过程"><a href="#测试执行过程" class="headerlink" title="测试执行过程"></a>测试执行过程</h4><h5 id="HCIbench工具下载及部署"><a href="#HCIbench工具下载及部署" class="headerlink" title="HCIbench工具下载及部署"></a>HCIbench工具下载及部署</h5><p>首先从VMware官网下载的HCIbench模板，链接：<a target="_blank" rel="noopener" href="https://flings.vmware.com/hcibench">https://flings.vmware.com/hcibench</a></p>
<p>接着在vSAN集群中部署HCIbench虚拟机，具体步骤如下：</p>
<ol>
<li><p>选择下载的OVF模板。</p>
<img src="/posts/4901/zh-cn_image_0000001115391457.png" class=""></li>
<li><p>选择部署虚拟机的数据中心和集群。</p>
<img src="/posts/4901/zh-cn_image_0000001115186927.png" class=""></li>
<li><p>选择一个vSAN数据存储进行部署。</p>
<img src="/posts/4901/zh-cn_image_0000001115186929.png" class=""></li>
<li><p>选择虚拟机部署的网络。</p>
<img src="/posts/4901/zh-cn_image_0000001115326985.png" class=""></li>
<li><p>输入HCIbench虚拟机的root密码。</p>
<img src="/posts/4901/zh-cn_image_0000001115391459.png" class=""></li>
<li><p>完成配置，等虚拟机部署完成后启动电源。</p>
<img src="/posts/4901/zh-cn_image_0000001115549939.png" class=""></li>
<li><p>登录HCIbench测试页面地址<a target="_blank" rel="noopener" href="https://hcibenchip/8443%EF%BC%8C%E5%B9%B6%E8%BE%93%E5%85%A5%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84%E7%94%A8%E6%88%B7%E5%90%8D%E5%92%8C%E5%AF%86%E7%A0%81%E5%90%8E%E5%8F%AF%E4%BB%A5%E8%BF%9B%E5%85%A5%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0%E4%B8%BB%E9%A1%B5%EF%BC%8C%E5%A6%82%E4%B8%8B%E5%9B%BE%EF%BC%9A">https://HCIbenchIP:/8443，并输入虚拟机的用户名和密码后可以进入配置参数主页，如下图：</a></p>
<img src="/posts/4901/zh-cn_image_0000001115186931.png" class=""></li>
</ol>
<h5 id="设定测试参数"><a href="#设定测试参数" class="headerlink" title="设定测试参数"></a>设定测试参数</h5><p>首先在“Configuration”页面输入集群相关信息，如vCenter IP、vCenter登录账户、数据中心名等，接着选择底层基准测试工具为fio,然后在Guest VM Confituration配置填入响应的负载组合参数，例如每台主机4个VM，每个VM8个虚拟磁盘，每个磁盘大小100G，如下图：</p>
<img src="/posts/4901/zh-cn_image_0000001115549943.png" class="">

<p>在上图的“Workload Parameter File”中选择“ADD”可以新建IO参数配置表，具体涉及的参数选项如下：</p>
<img src="/posts/4901/zh-cn_image_0000001115326987.png" class="">

<p>上图的负载参数配置完成后，会自动在配置主页生成配置选项，保存之后点击“start test”即可自动化执行测试，如下图：</p>
<img src="/posts/4901/zh-cn_image_0000001115391463.png" class="">

<h5 id="收集测试结果"><a href="#收集测试结果" class="headerlink" title="收集测试结果"></a>收集测试结果</h5><p>当完成一次测试后，点击参数配置页的“Review Result”可以查看本次测试运行结果，包含整体性能测试参数，如下图：</p>
<img src="/posts/4901/zh-cn_image_0000001115549945.png" class="">

<p>此外，还包含了所有虚拟机相关的性能参数，例如IOPS吞吐量、读写延迟等</p>
<img src="/posts/4901/zh-cn_image_0000001115186933.png" class="">

<p>点击参数配置页的“Save Result”可以保存本次测试运行结果。</p>
<h4 id="测试记录及分析"><a href="#测试记录及分析" class="headerlink" title="测试记录及分析"></a>测试记录及分析</h4><p>在实际测试过程中综合以上所述的负载组合和运行参数，包含了几十种业务负载场景，梳理测试记录大致如下表：</p>
<img src="/posts/4901/zh-cn_image_0000001115549947.png" class="">

<p>通过以上测试记录，可以得出以下几点测试结论：</p>
<ul>
<li>测试虚拟机如果要模拟大的IO 写吞吐量，可以使用较大的快尺寸，且尽量减少混合比例。</li>
<li>测试虚拟机如果需要模拟大的延迟，影响较大的因素是调高虚拟磁盘的队列深度，但要跟实际使用的物理磁盘相关联。通常来说SSD磁盘队列深度为256，HDD磁盘队列深度为32；其次可以增加虚拟机数量。</li>
<li>测试虚拟机如果需要模拟高的IO读写性能且尽可能符合常用业务模型，推荐使用70r30w100Random模型，4k大小的块尺寸（为最大程度避免出现一些常见的类似日志拥堵的异常，其实在调试的过程中块大小应该用4k的倍数）。</li>
<li>如果在测试过程中引入模拟故障，与正常测试状态相比IO读写性能和吞吐量会有一定程度的下降。</li>
<li>负载测试过程中，若要提高某一项性能指标，不能单一对虚拟机或虚拟磁盘加的过大，否则容易导致vSAN内部组件内存不足出现vmkernel报错，导致收集的测试结果为空。</li>
</ul>
<h4 id="问题复现结果"><a href="#问题复现结果" class="headerlink" title="问题复现结果"></a>问题复现结果</h4><ul>
<li><p>通过收集以上负载模型的测试结果，在系统参数/LSOM/diskIoTimeout &lt;= 3s的条件下可以复现出与客户故障一致的场景，即系统日志和RAID卡日志中出现关键的日志报错信息。</p>
</li>
<li><p>3408卡的7.703、7.706和7.713驱动的故障复现对比。</p>
<img src="/posts/4901/zh-cn_image_0000001115549949.png" class=""></li>
</ul>
<h2 id="解决方案-amp-建议"><a href="#解决方案-amp-建议" class="headerlink" title="解决方案&amp;建议"></a>解决方案&amp;建议</h2><h3 id="升级RAID卡驱动及固件"><a href="#升级RAID卡驱动及固件" class="headerlink" title="升级RAID卡驱动及固件"></a>升级RAID卡驱动及固件</h3><h5 id="升级的必要性"><a href="#升级的必要性" class="headerlink" title="升级的必要性"></a>升级的必要性</h5><p>vSAN属于硬件强认证的超融合存储方案，首先需要保证集群的RAID卡和磁盘的型号、驱动、固件版本必须在VMware官网的兼容性列表范围内；其实，RAID卡厂商针对旧版本出现过的问题都会通过升级来修复，因此在满足VCG的基础上尽可能地升级到已通过IOVP认证的最新版本，此外出现vSAN软件方面的问题时VMware通常也会要求客户升级完成后才会介入问题处理。</p>
<h5 id="驱动升级方法"><a href="#驱动升级方法" class="headerlink" title="驱动升级方法"></a>驱动升级方法</h5><ol>
<li><p>RAID卡的驱动可以直接在VMware官网上进行下载，下面以7.713.07.00为例进行介绍，下载链接：<a target="_blank" rel="noopener" href="https://my.vmware.com/web/vmware/details?downloadGroup=DT-ESXI65-BROADCOM-LSI-MR3-77130700-1OEM&amp;productId=614">https://my.vmware.com/web/vmware/details?downloadGroup=DT-ESXI65-BROADCOM-LSI-MR3-77130700-1OEM&amp;productId=614</a></p>
</li>
<li><p>获得驱动包后上传到ESXi主机上，然后通过ESXi的通用命令行安装方式进行升级。</p>
<img src="/posts/4901/zh-cn_image_0000001115326993.png" class="">

<p>以上提示说明升级成功，重启主机后新驱动可以生效。</p>
<img src="/posts/4901/icon-note.png" class=""> **说明：**

<p>如果驱动版本需要回退，操作方法与升级完全相同，执行上述命令即可，系统会自动remove现有的驱动并安装新的驱动。</p>
</li>
</ol>
<h5 id="固件升级方法"><a href="#固件升级方法" class="headerlink" title="固件升级方法"></a>固件升级方法</h5><ol>
<li><p>RAID卡的固件升级需要先下载RAID卡管理工具和固件包。</p>
<ul>
<li><p>RAID卡管理工具需要登录博通官网进行下载，链接：</p>
<p><a target="_blank" rel="noopener" href="https://www.broadcom.com/products/storage/raid-controllers/megaraid-9440-8i#downloads">https://www.broadcom.com/products/storage/raid-controllers/megaraid-9440-8i#downloads</a></p>
<p>通常是后缀为.vib的安装包，如下图：</p>
<img src="/posts/4901/zh-cn_image_0000001115391471.png" class=""></li>
<li><p>固件包可以在Support网站</p>
<p>FusionServer iDriver</p>
<p>下载，通常是后缀为.rom的安装包（如果是公司还未引入的固件版本，那么须通过兼容性测试团队找厂商提供固件包）。</p>
<img src="/posts/4901/zh-cn_image_0000001115186937.png" class=""></li>
</ul>
</li>
<li><p>获得以上安装包后先上传到ESXi主机，首先安装管理工具storcli.vib，命令如下：</p>
<img src="/posts/4901/zh-cn_image_0000001115326995.png" class=""></li>
<li><p>该工具安装完成后无需重启，然后切换到/opt/lsi/storcli目录下，执行以下命令进行升级：</p>
<p><strong>./storcli /c0 download file=HuaWei_SAS3408_nopad.rom noverchk</strong></p>
<p>升级截图及结果如下：</p>
<img src="/posts/4901/zh-cn_image_0000001115391473.png" class="">

<p>固件升级成功后需要重启主机使新固件生效。</p>
<img src="/posts/4901/icon-note.png" class=""> **说明：**

<p>如果固件版本需要回退，同样执行上图执行的命令即可。命令的最后一个参数noverchk表示跳过版本验证，如果不带该参数，则该命令只能用于升级，加了该参数后升级和回退都可以适用。</p>
</li>
</ol>
<h4 id="验证集群配置一致性"><a href="#验证集群配置一致性" class="headerlink" title="验证集群配置一致性"></a>验证集群配置一致性</h4><p>实际现网问题中，排查过程中发现问题经常都出在集群的配置上，最基础的要求是所有的节点的OS版本、RAID卡型号及驱动版本要保持一致；其次使用的磁盘模型必须一致，例如所有节点都是混合模式或者都为全闪存；此外，所有节点的磁盘类型没有强制要求，但为了达到最佳的性能和利用率，推荐使用型号和固件版本一致的磁盘，至少容量和性能等级要求保持一致；例如在刚果项目中综合使用了Micron和Intel的磁盘作为容量盘，但两种磁盘的性能等级不一致（C和E），其实也会影响vSAN集群整体的性能。</p>
<p>集群的整体磁盘信息状态检测可通过vc-support日志查看，解压vc-support日志后，然后打开commands目录中的文件python_usrlibvmware-vpxvsan-healthvsan-vc-health-statuspy-rvc-basic-support-information.txt，可以查到集群中每个节点包含的磁盘数量、磁盘型号、使用率及磁盘格式等。如果要查看每个节点，截图如下：</p>
<img src="/posts/4901/zh-cn_image_0000001115186941.png" class="">

<p>集群的整体RAID卡驱动和固件版本检查可通过集群健康状态诊断，具体可参照<a target="_blank" rel="noopener" href="https://support-it.huawei.com/docs/zh-cn/typical-scenarios-1/server-knowledgebase/zh-cn_topic_0000001115186865.html">集群健康状态诊断</a>，单台主机的RAID卡详细信息可查找vm-support日志下commands目录的localcli_vsan-debug-controller-list.txt文件，信息截图如下：</p>
<img src="/posts/4901/zh-cn_image_0000001115549951.png" class="">

<h4 id="系统参数优化"><a href="#系统参数优化" class="headerlink" title="系统参数优化"></a>系统参数优化</h4><p>vSAN集群运行过程中，由于比较早的ESXi版本存在一些bug，有时候须通过调整vSAN内部组件参数，如/LSOM/diskIoTimeout、/LSOM/blPLOGCacheLines、/LSOM/blLLOGCacheLines、/LSOM/blPLOGLsnCacheLines等首先获取这些参数的当前值命令如下图所示：</p>
<img src="/posts/4901/zh-cn_image_0000001115326997.png" class="">

<p>在vSAN集群实际负载测试过程中，为了避免出现各种拥堵类的故障以及减少IO超时影响,可以根据实际情况适当增加以上几个参数的值，以/LSOM/diskIoTimeout为例，如果要将该值调整为10s则执行命令如下：</p>
<img src="/posts/4901/zh-cn_image_0000001115391475.png" class="">

<h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><h3 id="VMware官网知识库"><a href="#VMware官网知识库" class="headerlink" title="VMware官网知识库"></a>VMware官网知识库</h3><p>问题排查和日志分析过程中，分析重要信息时第一优先级搜索VMware官网知识库（KB）,在KB中尝试输入不同关键字，可快速获取是否已有类似案例及解决措施，链接地址如下：</p>
<p><a target="_blank" rel="noopener" href="https://kb.vmware.com/s/">https://kb.vmware.com/s/</a></p>
<h3 id="vSAN诊断工具RVC"><a href="#vSAN诊断工具RVC" class="headerlink" title="vSAN诊断工具RVC"></a>vSAN诊断工具RVC</h3><p>如果需要对客户环境进行实时排查，可以通过vCenter中的rvc命令在线查看整个集群的状态，需要通过ssh登录到vCenter主机的BASH，详细操作手册可访问vmware官网，链接地址：</p>
<p><a target="_blank" rel="noopener" href="https://www.vmware.com/content/dam/digitalmarketing/vmware/en/pdf/products/vsan/vmware-ruby-vsphere-console-command-reference-for-virtual-san.pdf">https://www.vmware.com/content/dam/digitalmarketing/vmware/en/pdf/products/vsan/vmware-ruby-vsphere-console-command-reference-for-virtual-san.pdf</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:gaoshuais@126.com">gaoshuai</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://www.gaoshuais.top/posts/4901/">https://www.gaoshuais.top/posts/4901/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://www.gaoshuais.top" target="_blank">HILL</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/VMware/">VMware</a></div><div class="post_share"><div class="social-share" data-image="/img/head.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/17395/"><img class="prev-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">vSAN系统日志收集指导</div></div></a></div><div class="next-post pull-right"><a href="/posts/31022/"><img class="next-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">VMvare的HBA卡驱动存储常见案例</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/31022/" title="VMvare的HBA卡驱动存储常见案例"><img class="cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-04-19</div><div class="title">VMvare的HBA卡驱动存储常见案例</div></div></a></div><div><a href="/posts/2252/" title="VMware日志分析方法"><img class="cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-04-19</div><div class="title">VMware日志分析方法</div></div></a></div><div><a href="/posts/22695/" title="VMware系统紫屏问题定位思路"><img class="cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-04-19</div><div class="title">VMware系统紫屏问题定位思路</div></div></a></div><div><a href="/posts/17395/" title="vSAN系统日志收集指导"><img class="cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-04-19</div><div class="title">vSAN系统日志收集指导</div></div></a></div><div><a href="/posts/1686/" title="服务器VMware紫屏问题定界工具方案"><img class="cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-04-20</div><div class="title">服务器VMware紫屏问题定界工具方案</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="/img/head.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">gaoshuai</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">23</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">8</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/gaoshuais/"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">随缘更新</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#vSAN%E7%A3%81%E7%9B%98offline%E5%9C%BA%E6%99%AF%E6%93%8D%E4%BD%9C%E5%BB%BA%E8%AE%AE%E6%8C%87%E5%AF%BC"><span class="toc-number">1.</span> <span class="toc-text">vSAN磁盘offline场景操作建议指导</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B8%A2%E7%9B%98%E9%97%AE%E9%A2%98%E5%AE%9A%E7%95%8C%E5%AE%9A%E4%BD%8D%E6%B5%81%E7%A8%8B"><span class="toc-number">1.2.</span> <span class="toc-text">踢盘问题定界定位流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E7%8E%B0%E8%B1%A1%E5%8F%8A%E5%91%8A%E8%AD%A6"><span class="toc-number">1.2.1.</span> <span class="toc-text">问题现象及告警</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%91%E6%8E%A7%E9%A1%B5%E9%9D%A2%E5%91%8A%E8%AD%A6"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">监控页面告警</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#vCenter%E5%90%8E%E7%AB%AF%E5%91%8A%E8%AD%A6"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">vCenter后端告警</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RAID%E5%8D%A1%E4%BF%A1%E6%81%AF%E5%91%8A%E8%AD%A6"><span class="toc-number">1.2.1.3.</span> <span class="toc-text">RAID卡信息告警</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%91%8A%E8%AD%A6%E5%88%86%E6%9E%90"><span class="toc-number">1.2.1.4.</span> <span class="toc-text">告警分析</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86"><span class="toc-number">1.2.2.</span> <span class="toc-text">日志收集</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">系统日志收集</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RAID%E5%8D%A1%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">RAID卡日志收集</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#iBMC%E7%A1%AC%E4%BB%B6%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">iBMC硬件日志收集</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E4%BF%A1%E6%81%AF%E6%A3%80%E6%9F%A5"><span class="toc-number">1.2.3.</span> <span class="toc-text">集群信息检查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E5%81%A5%E5%BA%B7%E7%8A%B6%E6%80%81%E8%AF%8A%E6%96%AD"><span class="toc-number">1.2.4.</span> <span class="toc-text">集群健康状态诊断</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90%E5%8F%AF%E8%A7%86%E5%8C%96%E5%B7%A5%E5%85%B7"><span class="toc-number">1.2.5.</span> <span class="toc-text">集群日志分析可视化工具</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IO%E8%B6%85%E6%97%B6%E5%8E%9F%E5%9B%A0%E5%AE%9A%E7%95%8C"><span class="toc-number">1.2.6.</span> <span class="toc-text">IO超时原因定界</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90"><span class="toc-number">1.2.6.1.</span> <span class="toc-text">系统日志分析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#vm-support%E6%97%A5%E5%BF%97%E5%8C%85%E7%BB%93%E6%9E%84"><span class="toc-number">1.2.6.1.1.</span> <span class="toc-text">vm-support日志包结构</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#vobd-log%E5%88%86%E6%9E%90"><span class="toc-number">1.2.6.1.2.</span> <span class="toc-text">vobd.log分析</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#VMkernel-log%E7%9A%84SCSI%E7%A0%81%E8%A7%A3%E6%9E%90"><span class="toc-number">1.2.6.1.3.</span> <span class="toc-text">VMkernel.log的SCSI码解析</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#VMkwarning-log%E5%88%86%E6%9E%90"><span class="toc-number">1.2.6.1.4.</span> <span class="toc-text">VMkwarning.log分析</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RAID%E5%8D%A1%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90"><span class="toc-number">1.2.6.2.</span> <span class="toc-text">RAID卡日志分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E6%9E%90%E7%BB%93%E8%AE%BA"><span class="toc-number">1.2.6.3.</span> <span class="toc-text">分析结论</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%BC%E5%AE%B9%E6%80%A7%E5%8E%9F%E5%9B%A0%E5%AE%9A%E7%95%8C"><span class="toc-number">1.2.7.</span> <span class="toc-text">兼容性原因定界</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E8%BF%87VCG%E6%9F%A5%E8%AF%A2vSAN%E9%83%A8%E4%BB%B6%E5%85%BC%E5%AE%B9%E6%80%A7"><span class="toc-number">1.2.7.1.</span> <span class="toc-text">通过VCG查询vSAN部件兼容性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E5%8F%AF%E8%A7%86%E5%8C%96%E5%B7%A5%E5%85%B7%E6%9F%A5%E8%AF%A2%E5%85%BC%E5%AE%B9%E6%80%A7"><span class="toc-number">1.2.7.2.</span> <span class="toc-text">通过可视化工具查询兼容性</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A1%AC%E4%BB%B6%E7%B1%BB%E5%8E%9F%E5%9B%A0%E5%AE%9A%E7%95%8C"><span class="toc-number">1.2.8.</span> <span class="toc-text">硬件类原因定界</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BD%AF%E4%BB%B6%E7%B1%BB%E5%8F%8A%E5%85%B6%E5%AE%83%E5%8E%9F%E5%9B%A0%E5%AE%9A%E7%95%8C"><span class="toc-number">1.2.9.</span> <span class="toc-text">软件类及其它原因定界</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#vc-support%E6%97%A5%E5%BF%97%E6%A6%82%E8%BF%B0"><span class="toc-number">1.2.9.1.</span> <span class="toc-text">vc-support日志概述</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#vc-support%E6%97%A5%E5%BF%97%E5%8C%85%E7%BB%93%E6%9E%84"><span class="toc-number">1.2.9.2.</span> <span class="toc-text">vc-support日志包结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#vmware-vsan-health-summary-result-log%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90"><span class="toc-number">1.2.9.3.</span> <span class="toc-text">vmware-vsan-health-summary-result.log日志分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#vpxd-log%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90"><span class="toc-number">1.2.9.4.</span> <span class="toc-text">vpxd.log日志分析</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E5%A4%8D%E7%8E%B0%E6%B5%8B%E8%AF%95%E6%96%B9%E6%A1%88"><span class="toc-number">1.3.</span> <span class="toc-text">问题复现测试方案</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E8%83%8C%E6%99%AF%E5%92%8C%E7%9B%AE%E6%A0%87"><span class="toc-number">1.3.1.</span> <span class="toc-text">测试背景和目标</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.3.2.</span> <span class="toc-text">测试工具介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.3.</span> <span class="toc-text">测试环境配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IO%E8%B4%9F%E8%BD%BD%E8%A7%84%E5%88%92%E4%BE%9D%E6%8D%AE"><span class="toc-number">1.3.4.</span> <span class="toc-text">IO负载规划依据</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E6%80%9D%E8%B7%AF"><span class="toc-number">1.3.4.1.</span> <span class="toc-text">测试思路</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IO%E6%80%A7%E8%83%BD%E6%8C%87%E6%A0%87%E5%8F%8A%E8%B4%9F%E8%BD%BD%E7%BB%84%E5%90%88"><span class="toc-number">1.3.4.2.</span> <span class="toc-text">IO性能指标及负载组合</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%85%E9%9A%9C%E5%9C%BA%E6%99%AF%E6%A8%A1%E6%8B%9F"><span class="toc-number">1.3.4.3.</span> <span class="toc-text">故障场景模拟</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IO%E8%B4%9F%E8%BD%BD%E6%B5%8B%E8%AF%95%E5%8F%82%E6%95%B0"><span class="toc-number">1.3.4.4.</span> <span class="toc-text">IO负载测试参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B"><span class="toc-number">1.3.4.5.</span> <span class="toc-text">测试执行过程</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#HCIbench%E5%B7%A5%E5%85%B7%E4%B8%8B%E8%BD%BD%E5%8F%8A%E9%83%A8%E7%BD%B2"><span class="toc-number">1.3.4.5.1.</span> <span class="toc-text">HCIbench工具下载及部署</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AE%BE%E5%AE%9A%E6%B5%8B%E8%AF%95%E5%8F%82%E6%95%B0"><span class="toc-number">1.3.4.5.2.</span> <span class="toc-text">设定测试参数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%94%B6%E9%9B%86%E6%B5%8B%E8%AF%95%E7%BB%93%E6%9E%9C"><span class="toc-number">1.3.4.5.3.</span> <span class="toc-text">收集测试结果</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E8%AE%B0%E5%BD%95%E5%8F%8A%E5%88%86%E6%9E%90"><span class="toc-number">1.3.4.6.</span> <span class="toc-text">测试记录及分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E5%A4%8D%E7%8E%B0%E7%BB%93%E6%9E%9C"><span class="toc-number">1.3.4.7.</span> <span class="toc-text">问题复现结果</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-amp-%E5%BB%BA%E8%AE%AE"><span class="toc-number">1.4.</span> <span class="toc-text">解决方案&amp;建议</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%87%E7%BA%A7RAID%E5%8D%A1%E9%A9%B1%E5%8A%A8%E5%8F%8A%E5%9B%BA%E4%BB%B6"><span class="toc-number">1.4.1.</span> <span class="toc-text">升级RAID卡驱动及固件</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8D%87%E7%BA%A7%E7%9A%84%E5%BF%85%E8%A6%81%E6%80%A7"><span class="toc-number">1.4.1.0.1.</span> <span class="toc-text">升级的必要性</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%A9%B1%E5%8A%A8%E5%8D%87%E7%BA%A7%E6%96%B9%E6%B3%95"><span class="toc-number">1.4.1.0.2.</span> <span class="toc-text">驱动升级方法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9B%BA%E4%BB%B6%E5%8D%87%E7%BA%A7%E6%96%B9%E6%B3%95"><span class="toc-number">1.4.1.0.3.</span> <span class="toc-text">固件升级方法</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E9%9B%86%E7%BE%A4%E9%85%8D%E7%BD%AE%E4%B8%80%E8%87%B4%E6%80%A7"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">验证集群配置一致性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E5%8F%82%E6%95%B0%E4%BC%98%E5%8C%96"><span class="toc-number">1.4.1.2.</span> <span class="toc-text">系统参数优化</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%84%E5%BD%95"><span class="toc-number">1.5.</span> <span class="toc-text">附录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#VMware%E5%AE%98%E7%BD%91%E7%9F%A5%E8%AF%86%E5%BA%93"><span class="toc-number">1.5.1.</span> <span class="toc-text">VMware官网知识库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#vSAN%E8%AF%8A%E6%96%AD%E5%B7%A5%E5%85%B7RVC"><span class="toc-number">1.5.2.</span> <span class="toc-text">vSAN诊断工具RVC</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/64295/" title="centos K8S容器部署-flannel网络版">centos K8S容器部署-flannel网络版</a><time datetime="2022-04-24T13:51:40.000Z" title="发表于 2022-04-24 21:51:40">2022-04-24</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/17566/" title="Mac中用到的SSH相关命令">Mac中用到的SSH相关命令</a><time datetime="2022-04-23T12:51:44.000Z" title="发表于 2022-04-23 20:51:44">2022-04-23</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/23200/" title="修改 VMware Fusion 中的虚机网络 IP 地址段">修改 VMware Fusion 中的虚机网络 IP 地址段</a><time datetime="2022-04-23T12:46:18.000Z" title="发表于 2022-04-23 20:46:18">2022-04-23</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/42673/" title="Photoshop2020默认快捷键整理（Mac版）">Photoshop2020默认快捷键整理（Mac版）</a><time datetime="2022-04-23T12:42:09.000Z" title="发表于 2022-04-23 20:42:09">2022-04-23</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/posts/56602/" title="关于 NSX-T 下的 MTU（下）">关于 NSX-T 下的 MTU（下）</a><time datetime="2022-04-22T01:47:42.000Z" title="发表于 2022-04-22 09:47:42">2022-04-22</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By gaoshuai</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '86MGRvKe88fxFgDHAqjUQBbr-gzGzoHsz',
      appKey: 'NCmk6LfPzxxN4NPnVFQEQ75H',
      placeholder: 'Please leave your footprints',
      avatar: 'monsterid',
      meta: 'nick,mail,link'.split(','),
      pageSize: '10',
      lang: 'zh-CN',
      recordIP: false,
      serverURLs: '',
      emojiCDN: '',
      emojiMaps: "",
      enableQQ: false,
      path: window.location.pathname,
      requiredFields: ["nick,mail"],
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><script src="https://cdn.jsdelivr.net/gh/sviptzk/HexoStaticFile@latest/Hexo/js/hideCategory.min.js"></script> - <script src="https://cdn.jsdelivr.net/gh/sviptzk/HexoStaticFile@latest/Hexo/js/mouse_snow.min.js"></script> - <script src="/js/live2d.min.js"></script> - <script src="/js/waifu-tips.js"></script> - <script src="https://cdn.jsdelivr.net/npm/meting@2.0.1/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = [
  'title',
  '#config-diff',
  '#body-wrap',
  '#rightside-config-hide',
  '#rightside-config-show',
  '.js-pjax'
]

if (false) {
  pjaxSelectors.unshift('meta[property="og:image"]', 'meta[property="og:title"]', 'meta[property="og:url"]')
}

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener toc scroll 
  window.removeEventListener('scroll', window.tocScrollFn)

  typeof preloader === 'object' && preloader.initLoading()
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // Analytics
  if (false) {
    MtaH5.pgv()
  }

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"left","width":180,"height":360},"mobile":{"show":true},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>